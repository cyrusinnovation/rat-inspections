<!doctype html>
<html>
	<head>
		<title>Rat Inspections</title>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<style type="text/css" media="screen">
			#map {
				height: 800px;
			}	
		</style>
	</head>
	<body>
		<div id="map"></div>

		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/queue.v1.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.runtime.min.js" charset="utf-8"></script>
		<script src="popup_template.js"></script>

		<script>
			var map = L.map('map').setView([40.74023, -73.96202], 12);
	    	var Stamen_TonerLite = L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
				attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
				subdomains: 'abcd',
				minZoom: 10,
				maxZoom: 20
			});
			Stamen_TonerLite.addTo(map);

			var colorScale = function (value) {
				if (value < 10)
					return '#ffeda0';
				else if (value < 20)
					return '#feb24c';
				else
					return '#f03b20';
			}

			var customLayer = L.geoJson(null, {
				// http://leafletjs.com/reference.html#geojson-style
				style: function(feature) {
					var feature_color = colorScale(feature.properties.ActiveCount);
					return {
						color: 'darkgray',
						fillColor: feature_color,
					    "weight": 1,
					    "opacity": 1,
					    fillOpacity: 0.75
					};
				}
			});

			var createPopups = function () {
				queue()
					.defer(d3.csv, "inspections_for_most_active.csv")
					.defer(d3.csv, "nyc_building_codes.csv")
					.await(ready)

				function ready(error, inspections, building_codes) {

					code_index = d3.nest()
							.key(function(d) { return d.Code; })
							.map(building_codes, d3.map);

					inspection_index = d3.nest()
							.key(function(d) { return d.BBL; })
							.map(inspections, d3.map);

					features.eachLayer(function (layer) {
						var codeDesc = code_index.get(layer.feature.properties.BldgClass)[0].Description;
						layer.bindPopup(Handlebars.templates.popup(layer.feature.properties));
						// layer.bindPopup("<p><b>Active Count:</b> "+layer.feature.properties.ActiveCount+"</p><p>Building Code: "+codeDesc+"</p><p>"+
						// 	inspection_index.get(layer.feature.id)[0].RESULT+"</p>");
					});
				}
			}

			var features = omnivore.topojson('shapefiles/most_active.topojson',null,customLayer).on('ready', createPopups);

			features.addTo(map);

		</script>
	</body>
</html>